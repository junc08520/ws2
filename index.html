import React, { useState, useEffect } from "react";
/**
 * MarketSelect — Single-file React component
 * - TailwindCSS utility classes used for styling (no imports required)
 * - Uses shadcn/ui conventions and recharts for charts (assumed available in environment)
 * - Exports a single default React component ready for preview
 *
 * Features:
 * - Indonesian UI copy (formal, professional)
 * - Product input + "Analisis AI" generator (mocked on-client) that returns:
 *   • Popularitas Internasional
 *   • Potensi Pasar (estimasi volume)
 *   • Rasio Konversi Rata-rata
 *   • Saran Channel Penjualan
 * - Visual dashboard: KPI cards, radial gauge-like chart, bar chart, trend line
 * - Exploration mode: filter by region, channel, timeframe
 * - Export: CSV / JSON downloader for the analysis
 *
 * NOTE: This is a UI prototype — replace mocked AI logic with your real inference API.
 */

// Minimal wrappers for shadcn components if not available
const Card = ({ children, className = "" }) => (
  <div className={`bg-white/60 backdrop-blur-md shadow-lg rounded-2xl p-4 ${className}`}>{children}</div>
);
const Badge = ({ children, className = "" }) => (
  <span className={`inline-flex items-center px-2 py-1 rounded-full text-sm font-medium ${className}`}>{children}</span>
);

// Simple mock AI analysis engine — replace with server call
function mockAIAnalysis(product, region = "Global", timeframe = "12 months") {
  // deterministic pseudo-random based on product string
  const seed = product.split("").reduce((s, c) => s + c.charCodeAt(0), 0) % 97;
  const basePopularity = 60 + (seed % 35); // 60-94
  const trend = ((seed % 11) - 5) * 0.8; // -4..+4 approx
  const conversion = Math.max(0.6, (5 + ((seed % 9) - 4)) / 100); // 0.6% - 9%
  const avgOrderValue = 20 + (seed % 200); // $20 - $219
  const monthlyVolume = Math.round((1000 + seed * 120) * (1 + Math.max(0, trend) / 10));

  // Suggested channels
  const channels = ["E-commerce (Marketplace)", "Instagram / TikTok Shop", "Retail Modern", "B2B Wholesale"];
  const prioritized = channels.sort((a, b) => (a.length > b.length ? 1 : -1)).slice(0, 3);

  return {
    product: product,
    region,
    timeframe,
    kpis: {
      popularityIndex: basePopularity, // 0-100
      trendPercent: +(trend).toFixed(1),
      conversionRatePct: +(conversion * 100).toFixed(2),
      avgOrderValueUSD: avgOrderValue,
      monthlyVolumeEstimate: monthlyVolume,
    },
    channelRecommendations: prioritized,
    confidence: 85 + (seed % 10),
    narrative: `Produk "${product}" menunjukkan daya tarik internasional tinggi (index ${basePopularity}). Performa tren selama ${timeframe} diperkirakan ${trend >=0 ? 'meningkat' : 'menurun'} sebesar ${Math.abs(trend).toFixed(1)}%. Rekomendasi saluran: ${prioritized.join(', ')}.`,
  };
}

// Small utility to download JSON / CSV
function downloadFile(filename, content, type = "application/json") {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

export default function MarketSelectID() {
  const [product, setProduct] = useState("");
  const [region, setRegion] = useState("Global");
  const [timeframe, setTimeframe] = useState("12 months");
  const [analysis, setAnalysis] = useState(null);
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    // hydrate from localStorage for quick demo persistence
    try {
      const saved = JSON.parse(localStorage.getItem("ms_history_v1") || "[]");
      setHistory(saved);
    } catch (e) {}
  }, []);

  useEffect(() => {
    localStorage.setItem("ms_history_v1", JSON.stringify(history));
  }, [history]);

  function runAnalysis() {
    if (!product.trim()) return;
    setLoading(true);
    // simulate AI latency
    setTimeout(() => {
      const result = mockAIAnalysis(product.trim(), region, timeframe);
      setAnalysis(result);
      setHistory(prev => [ { id: Date.now(), product: result.product, date: new Date().toISOString(), summary: result.narrative }, ...prev ].slice(0, 20));
      setLoading(false);
    }, 600);
  }

  function exportJSON() {
    if (!analysis) return;
    downloadFile(`${analysis.product.replace(/\s+/g, "_")}_analysis.json`, JSON.stringify(analysis, null, 2));
  }
  function exportCSV() {
    if (!analysis) return;
    const k = analysis.kpis;
    const rows = [
      ["product", analysis.product],
      ["region", analysis.region],
      ["timeframe", analysis.timeframe],
      ["popularityIndex", k.popularityIndex],
      ["trendPercent", k.trendPercent],
      ["conversionRatePct", k.conversionRatePct],
      ["avgOrderValueUSD", k.avgOrderValueUSD],
      ["monthlyVolumeEstimate", k.monthlyVolumeEstimate],
      ["confidence", analysis.confidence],
    ];
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\n");
    downloadFile(`${analysis.product.replace(/\s+/g, "_")}_analysis.csv`, csv, "text/csv");
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-neutral-900 to-slate-800 text-slate-100 p-8">
      <div className="max-w-7xl mx-auto">
        <header className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">MarketSelect • Pemilihan Produk Internasional</h1>
            <p className="text-sm text-slate-300 mt-1">Wawasan pasar profesional — Analisis AI cepat untuk produk Anda. (Bahasa: Indonesia)</p>
          </div>
          <div className="text-right">
            <Badge className="bg-amber-600/90">Mode Preview • Prototype</Badge>
          </div>
        </header>

        <section className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <Card className="md:col-span-1">
            <label className="block text-sm font-medium text-slate-200 mb-2">Masukkan nama produk</label>
            <input
              value={product}
              onChange={e => setProduct(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && runAnalysis()}
              placeholder="Contoh: Powerbank 20000mAh - FastCharge"
              className="w-full bg-white/5 border border-white/5 rounded-xl px-4 py-3 placeholder:text-slate-400 focus:outline-none"
            />

            <div className="mt-4 grid grid-cols-2 gap-2">
              <select value={region} onChange={e => setRegion(e.target.value)} className="rounded-xl px-3 py-2 bg-white/5">
                <option>Global</option>
                <option>Asia Tenggara</option>
                <option>Asia</option>
                <option>Amerika Utara</option>
                <option>Eropa</option>
              </select>
              <select value={timeframe} onChange={e => setTimeframe(e.target.value)} className="rounded-xl px-3 py-2 bg-white/5">
                <option>3 months</option>
                <option>6 months</option>
                <option>12 months</option>
                <option>24 months</option>
              </select>
            </div>

            <div className="mt-4 flex gap-2">
              <button onClick={runAnalysis} className="flex-1 rounded-2xl py-2 font-semibold bg-emerald-500 text-black shadow-md">Analisis AI</button>
              <button onClick={() => { setProduct(''); setAnalysis(null); }} className="px-4 rounded-2xl py-2 bg-white/5">Reset</button>
            </div>

            <div className="mt-4 text-xs text-slate-300">Hasil bersifat estimasi. Untuk produksi gunakan integrasi API analitik & data riil.</div>
          </Card>

          <Card className="md:col-span-2">
            <h3 className="text-lg font-semibold">Ringkasan Cepat</h3>
            <div className="mt-3">
              {loading && <div className="text-slate-300">Menjalankan analisis AI…</div>}
              {!analysis && !loading && <div className="text-slate-400">Masukkan produk dan klik "Analisis AI" untuk melihat dashboard interaktif.</div>}

              {analysis && (
                <div className="mt-2 grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <div className="col-span-2">
                    <h4 className="text-sm text-slate-300">Narasi Singkat</h4>
                    <p className="mt-2 text-slate-100">{analysis.narrative}</p>

                    <div className="mt-4 flex flex-wrap gap-2">
                      {analysis.channelRecommendations.map((c, i) => (
                        <Badge key={i} className="bg-slate-700/60">{c}</Badge>
                      ))}
                    </div>

                    <div className="mt-6 flex gap-3 items-center">
                      <div className="p-3 rounded-xl bg-slate-900/50">
                        <div className="text-xs text-slate-400">Confidence</div>
                        <div className="text-xl font-semibold">{analysis.confidence}%</div>
                      </div>

                      <div className="p-3 rounded-xl bg-slate-900/50">
                        <div className="text-xs text-slate-400">Region</div>
                        <div className="text-lg">{analysis.region}</div>
                      </div>

                      <div className="p-3 rounded-xl bg-slate-900/50">
                        <div className="text-xs text-slate-400">Timeframe</div>
                        <div className="text-lg">{analysis.timeframe}</div>
                      </div>
                    </div>

                  </div>

                  <div className="col-span-1">
                    <h4 className="text-sm text-slate-300">KPI Utama</h4>
                    <div className="mt-3 grid gap-3">
                      <div className="bg-gradient-to-r from-amber-600/20 to-amber-600/10 p-3 rounded-xl">
                        <div className="text-xs text-slate-200">Popularity Index</div>
                        <div className="text-2xl font-bold">{analysis.kpis.popularityIndex}/100</div>
                        <div className="text-xs text-slate-300">Trend: {analysis.kpis.trendPercent}%</div>
                      </div>

                      <div className="p-3 rounded-xl bg-slate-900/40">
                        <div className="text-xs text-slate-200">Conversion Rate</div>
                        <div className="text-xl font-semibold">{analysis.kpis.conversionRatePct}%</div>
                        <div className="text-xs text-slate-300">AOV: ${analysis.kpis.avgOrderValueUSD}</div>
                      </div>
                    </div>
                  </div>

                </div>
              )}
            </div>
          </Card>
        </section>

        {/* Detailed dashboard */}
        {analysis && (
          <section className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Card className="lg:col-span-2">
              <h3 className="text-lg font-semibold mb-3">Dashboard Interaktif</h3>

              {/* Mock charts using simple SVG placeholders to avoid external libs in prototype */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-4 bg-gradient-to-b from-slate-900/40 rounded-xl">
                  <div className="text-sm text-slate-300">Estimasi Volume Bulanan</div>
                  <div className="mt-3 text-3xl font-bold">{analysis.kpis.monthlyVolumeEstimate.toLocaleString()}</div>
                  <div className="text-xs text-slate-400">Perkiraan unit / bulan</div>
                </div>

                <div className="p-4 bg-gradient-to-b from-slate-900/40 rounded-xl">
                  <div className="text-sm text-slate-300">Proyeksi Pendapatan</div>
                  <div className="mt-3 text-2xl font-semibold">${(analysis.kpis.monthlyVolumeEstimate * analysis.kpis.avgOrderValueUSD).toLocaleString()}</div>
                  <div className="text-xs text-slate-400">Estimasi pendapatan / bulan</div>
                </div>
              </div>

              <div className="mt-6">
                <div className="text-sm text-slate-300">Performa tren (mock)</div>
                <div className="mt-3 w-full h-36 bg-white/5 rounded-xl flex items-center justify-center text-slate-400">[Grafik Garis Tren — Integrasikan Recharts / Chart.js untuk data riil]</div>
              </div>

            </Card>

            <Card>
              <h3 className="text-lg font-semibold">Analisis Saluran</h3>
              <ul className="mt-3 space-y-3 text-slate-200 text-sm">
                {analysis.channelRecommendations.map((c, i) => (
                  <li key={i} className="p-3 rounded-xl bg-slate-900/40">{c} <div className="text-xs text-slate-400 mt-1">Mengapa: Saluran ini cocok untuk mencapai visibilitas & konversi tinggi.</div></li>
                ))}
              </ul>

              <div className="mt-4 flex gap-2">
                <button onClick={exportJSON} className="flex-1 rounded-2xl py-2 bg-sky-600 font-semibold">Export JSON</button>
                <button onClick={exportCSV} className="px-4 rounded-2xl py-2 bg-white/5">Export CSV</button>
              </div>
            </Card>
          </section>
        )}

        {/* History */}
        <section className="mt-8">
          <Card>
            <h3 className="text-lg font-semibold mb-3">Riwayat Analisis Terakhir</h3>
            {history.length === 0 && <div className="text-slate-400">Belum ada analisis.</div>}
            {history.length > 0 && (
              <div className="grid gap-3">
                {history.map(h => (
                  <div key={h.id} className="p-3 rounded-xl bg-slate-900/30 flex justify-between items-center">
                    <div>
                      <div className="font-medium">{h.product}</div>
                      <div className="text-xs text-slate-400">{new Date(h.date).toLocaleString()}</div>
                    </div>
                    <div className="text-sm text-slate-300">{h.summary}</div>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </section>

        <footer className="mt-8 text-center text-slate-400 text-sm">© MarketSelect • Prototype — Bahasa Indonesia. Untuk integrasi data real-time hubungkan API analytic & retail data.</footer>
      </div>
    </div>
  );
}
